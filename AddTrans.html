<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="keywords" content="html, css, 網頁, JS, javascript">
  <meta name="description" content="Here is my page.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="Ketchup" content="Chiao">
  <title>地址中翻英轉換器</title>

  <!--title小圖示-->
  <link rel="icon" href="/img/CJF.png">
  <!-- bootstrap js css-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
    crossorigin="anonymous"></script>


  <!--css-->
  <link rel="stylesheet" href="AddTrans_style.css">
  
  
  <!--字型--> <!--Google Font 免費字型 挑選 get font code-->

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Stick&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=New+Amsterdam&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

</head>

<body>



  <header>
    <nav class="navbar position-absolute top-0 end-0 p-3">
      <input type="checkbox" id="themeToggle" class="theme-toggle">
      <label for="themeToggle" class="toggle-icon" title="切換主題"></label>
    </nav>
  </header>

  <div class="main-container">
    <div id="project_name">
      <h2>台灣地址中翻英轉換器</h2>
    </div>

    <div class="d-flex flex-column align-items-center mt-5" style="max-width: 600px;">
      <!-- 中文地址輸入框 -->
      <div class="w-100 d-flex mb-3">
        <div class="form-floating flex-grow-1 me-2">
          <input type="text" class="form-control" id="chineseAddress" placeholder="中文地址">
          <label for="chineseAddress">中文地址</label>
        </div>
      </div>

      <!-- 英文地址顯示框 -->
      <div class="w-100 d-flex mb-3">
        <div class="form-floating flex-grow-1 me-2">
          <input type="text" class="form-control" id="englishAddress" placeholder="英文地址" readonly>
          <label for="englishAddress">英文地址</label>
        </div>
      </div>
    </div>

    <!-- ★★★ 新增：複製 / Google Maps 兩顆按鈕 ★★★ -->
    <div class="d-flex justify-content-center gap-3 mt-3">
      <button id="copyBtn" class="btn btn-outline-secondary px-4">
        複製英文地址
      </button>
      <button id="mapBtn" class="btn btn-outline-secondary px-4">
        Google Maps 搜尋
      </button>
    </div>

    <div id="label_source" style="text-align: center;">
      <a>資料來源：中華郵政公司（縣市鄉鎮中英對照檔、中英文街路名稱對照檔、村里文字巷中英對照文字檔）</a>
    </div>
  </div>

  <!-- 放在 <body> 任何位置（通常貼最底） -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="liveToast" class="toast align-items-center text-white bg-success border-0" role="alert"
      aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div id="toastBody" class="toast-body"> 已複製到剪貼簿！</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
  </div>

  <script>
    let countyMapping = {};
    let addressMapping = {};
    let streetMapping = {};

    window.onload = () => {
      Promise.all([
        fetch('County_address_mapping_with_zip.json').then(res => res.json()),
        fetch('address_mapping.json').then(res => res.json()),
        fetch('street_mapping.json').then(res => res.json())
      ]).then(([county, address, street]) => {
        countyMapping = county;
        addressMapping = address;
        streetMapping = street;
        console.log("JSON 讀取完成");
      });

      document.getElementById("chineseAddress")
        .addEventListener("input", convertAddress);
    };

    function convertAddress() {
      let input = document.getElementById('chineseAddress').value.trim();
      if (!input) {
        document.getElementById('englishAddress').value = "";
        return;
      }
      input = input.replace(/台/g, '臺');       // 統一「臺」

      /* -------- 1. 解析縣市區 & 郵遞區號 -------- */
      let zip = "", countyEN = "";
      const sortedCounty = Object.keys(countyMapping)
        .sort((a, b) => b.length - a.length);

      for (const key of sortedCounty) {
        if (input.includes(key)) {
          zip = countyMapping[key].zip || "";
          countyEN = countyMapping[key].en;        // 例如 "East Dist., Tainan City"
          input = input.replace(key, "");       // 拆掉中文縣市區
          break;
        }
      }
      if (!countyEN) {
        const cityOnly = input.match(/^[^\d巷弄號樓室]+?[市縣]/); // 抓開頭到「市/縣」 ★ 新增
        if (cityOnly) {
          const k = Object.keys(countyMapping).find(c => c.startsWith(cityOnly[0]));
          if (k) {
            countyEN = countyMapping[k].en.split(',').pop().trim();  // 只留 "Tainan City" ★ 新增
            input = input.replace(cityOnly[0], "");
          }
        }
      }
      /* -------- 2. 解析街道（如 XX 路、XX 街） -------- */
      let streetEN = "";
      const sortedStreet = Object.keys(streetMapping)
        .sort((a, b) => b.length - a.length);
      for (const key of sortedStreet) {
        if (input.includes(key)) {
          streetEN = streetMapping[key];           // 例如 "Rongyu St."
          input = input.replace(key, "");
          break;                                   // 只取第一個最長的街名
        }
      }

      /* -------- 3. 解析門牌／巷弄樓室 -------- */
      // 門牌必須提早擷取，才能放在最前面
      let laneAlleyEtc = "";   // Ln. / Aly. 等
      let doorNo = "";   // No. XXX (可能帶樓層)
      const extraRules = [
        { re: /(\d+)巷/g, repl: (m, n) => { laneAlleyEtc += `Ln. ${n}, `; return ""; } },
        { re: /(\d+)弄/g, repl: (m, n) => { laneAlleyEtc += `Aly. ${n}, `; return ""; } },
        {
          re: /(\d+)號(\d*)樓?/g, repl: (m, n, f) => {        // 同時支援「109號」、「109號3樓」
            doorNo = `No. ${n}${f ? `, ${f}F` : ""}`;
            return "";
          }
        }
      ];
      extraRules.forEach(rule => { input = input.replace(rule.re, rule.repl); });

      /* -------- 4. 如果還殘留中文方向字、道路段次，做基本轉換 -------- */
      const tailRules = [
        { re: /(\d+)樓/g, repl: '$1F' },
        { re: /(\d+)室/g, repl: 'Rm. $1' },
        { re: /東/g, repl: ' E.' }, { re: /西/g, repl: ' W.' },
        { re: /南/g, repl: ' S.' }, { re: /北/g, repl: ' N.' },
        { re: /一/g, repl: '1st' }, { re: /二/g, repl: '2nd' },
        { re: /三/g, repl: '3rd' }, { re: /四/g, repl: '4th' },
        { re: /五/g, repl: '5th' }
      ];
      tailRules.forEach(r => { input = input.replace(r.re, r.repl); });
      input = input.replace(/^\s*,\s*|\s*,\s*$/g, ""); // 去掉首尾逗號

      /* -------- 5. 依照想要的順序組裝 -------- */
      const pieces = [
        doorNo,                     // No. 109
        laneAlleyEtc.trimEnd(),     // Ln. / Aly.（若有）
        streetEN,                   // Rongyu St.
        countyEN                    // East Dist., Tainan City
      ].filter(Boolean)             // 移除空字串
        .map(p => p.replace(/\s*,\s*$/, "")); // 保險：把意外的結尾逗號砍掉

      let result = pieces.join(', ');
      if (zip) result += ` ${zip}`;        // 空白 + 郵遞區號
      result += ', Taiwan (R.O.C.)';

      document.getElementById('englishAddress').value = result;
    }
    /* --- 共用：Bootstrap Toast 工具函式 ------------------ */
    function showToast(message, variant = 'success') {
      // variant 可帶 'success' | 'danger' | 'warning' | 'info'
      const toastElement = document.getElementById('liveToast');
      const toastBody = document.getElementById('toastBody');

      // 更新文字
      toastBody.textContent = message;

      // 依 variant 換背景色
      toastElement.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
      toastElement.classList.add(`bg-${variant}`);

      // 建立 (或取得已存在的) Toast 實例並顯示
      const toast = bootstrap.Toast.getOrCreateInstance(toastElement);
      toast.show();
    }

    /* --- Copy to clipboard --- */
    document.getElementById('copyBtn').addEventListener('click', () => {
      const addr = document.getElementById('englishAddress').value.trim();
      if (!addr) {
        showToast('請先輸入中文地址並完成轉換', 'secondary');
        return;
      }

      navigator.clipboard.writeText(addr)
        .then(() => showToast('已複製到剪貼簿！', 'muted'))
        .catch(() => showToast('複製失敗，請檢查瀏覽器權限', 'secoendary'));
    });

    /* --- Open Google Maps --- */
    document.getElementById('mapBtn').addEventListener('click', () => {
      const addr = document.getElementById('englishAddress').value.trim();
      if (!addr) {
        showToast('請先輸入中文地址並完成轉換', 'secondary');
        return;
      }
      const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
      window.open(url, '_blank');
      showToast('已在新分頁開啟 Google Maps', 'secondary');
    });

    document.addEventListener('DOMContentLoaded', () => {
      // 這裡抓得到按鈕了
      document.getElementById('copyBtn').addEventListener('click', () => { });
      document.getElementById('mapBtn').addEventListener('click', () => { });
    });
  </script>


</body>

</html>